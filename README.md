## Bayesian modeling of multiple related precision matrices
R and Matlab code to reproduce results in "Bayesian modeling of multiple structural
connectivity networks during the progression of Alzheimerâ€™s disease" by Christine B. Peterson, Nathan Osborne, Francesco C. Stingo, Pierrick Bourgeat, James D. Doecke and Marina Vannucci

### Authors
Christine B. Peterson (cbpeterson@mdanderson.org) and Nathan Osborne (no7@rice.edu)

### File organization

### `Simulation`

#### `Code`

The following scripts can be run in the order given to reproduce the results for the comparison of methods in Section 5 (Simulation study). The working directory should be set to the top level directory within this project.

- `Set_up_precision_matrices.R`. This script constructs and saves the precision matrix for each of the three graphs considered.

- `Simulate_data.m`. Given the precision matrices for each group, this script generates and saves 25 simulated data sets.

- `Simulation_run_lpm.m`. Given the simulated precision matrices and data, runs the proposed linked precision matrix (lpm) MCMC code and saves performance summaries.

- `Simulation_run_sep.m`. Given the simulated precision matrices and data, runs the MCMC code for separate estimation using mixture priors (Wang 2015) and saves performance summaries.

- `Simulation_run_joint.m`. Given the simulated precision matrices and data, runs the MCMC code for joint estimation using mixture priors (Shaddox et al. 2017) and saves performance summaries.

- `Simulation_run_JGL.R`. Given the simulated precision matrices and data, applies the fused and group graphical lasso methods (Danaher et al. 2014) and saves performance summaries. Note that this requires installation of the `JGL` R package.

- `Simulation_summarize_results.R`. Given the output files generated by the scripts above, creates tables summarizing edge selection performance and differential edge selection performance (provided in Section 5.1 of the paper), as well as the posterior estimate of Phi (provided at the end of section 5.1).

#### `Input_files`

This directory includes the csv files constructed by `Set_up_precision_matrices.m` and `Simulate_data.m` i.e. the simulated precision matrices for each group and the simulated data sets. These files are included for convenience only, and are exactly reproducible from the scripts provided since the random number generator seeds have been fixed.

#### `Output_files`

This directory includes the results and performance summaries saved by the scripts applying each method to the simulated data. As for the input files, these are included for convenience only, and are exactly reproducible from the scripts provided -- specifically, `Simulation_run_lpm.m`, `Simulation_run_sep.m`, `Simulation_run_joint.m`, and `Simulation_run_JGL.R`.

### `MCMC_code`

Matlab code for running the MCMC sampling procedures for the proposed method, as well as other Bayesian methods run in the performance comparison of the simulation section.

- `MCMC_linked_precision_matrices.m`. Run MCMC for proposed method and return samples generated. This function is called by `Simulation_run_lpm.m` to generate samples of the precision matrices, graphs, and Phi matrix from the joint posterior distribution.

- `MCMC_resample_C_for_fixed_graph.m`. Run MCMC to resample the precision matrices for each group conditional on the posterior estimate of the Phi matrix and the selected adjacency matrices for each group. This function is called by `Simulation_run_lpm.m` after calling `MCMC_linked_precision_matrices.m`.

- `MCMC_sep_precision_matrices.m`. Run MCMC for separate Bayesian estimation for each group (separate estimation using mixture priors). This is essentially the SSGS method of Wang (2014) applied separately to each group.

- `MCMC_multiple_graphs_SSVS_Final.m`. Run MCMC for joint Bayesian estimation (joint estimation with mixture priors). This code was provided by Elin Shaddox in connection with the publication Shaddox et al. (2017).

- `BayesGGM_SSVS_FixedV0V1.m`. Run MCMC for separate Bayesian estimation for each group (separate estimation using mixture priors). This is code from the SSGS method of Wang (2014).


### `Helper_functions`

These helper functions are called from the scripts above, and do not need to be run separately.

- `fix_matrix.R`. This function is called from `Set_up_precision_matrices.R` to ensure positive definiteness of the precision matrices.

- `fix_matrix.m`. This is the Matlab version of `fix_matrix.R`.

- `rMNorm.m`. This function is called from `Simulate_data.m` to sample draws from the multivariate normal distribution.

- `logdet.m`. This function is called from the MCMC code to compute the log of the determinant of a matrix.

- `get_perf.m`. This function is called from `Simulation_run_lpm.m` to compute performance metrics including the true positive rate, false positive rate, and AUC for edge learning and differential edge learning and the Frobenius loss for precision matrix estimation.

- `get_tpr_fpr_mcc.m`. This function computes the true positive rate, false positive rate, and Matthew's correlation coefficient (MCC) for edge selection across K graphs. It is called from `get_perf.m`.

- `get_tpr_fpr_mcc_diff.m`. This function computes the true positive rate, false positive rate, and Matthew's correlation coefficient (MCC) for differential edge selection across K graphs. It is called from `get_perf.m`.

- `calc_mrf_C.m`. This function calculates the normalizing constant of the Markov Random Field prior used in Shaddox et al. (2017). It is called from `MCMC_multiple_graphs_SSVS_Final.m`.

- `get_perf_jgl.R`. Helper functions to compute performance metrics based on fused and group graphical lasso precision matrix estimates, including the true positive rate, false positive rate, and Matthew's correlation coefficient for edge selection and differential edge selection, as well as the edge selection and differential edge selection AUC. These functions are called from `Simulation_run_JGL.R`.

- `jgl_helper_functions.R`. Internal helper functions from the JGL package, as well as functions to calculate the AIC and perform a grid search for parameter values minimizing the AIC. These functions are called from `Simulation_run_JGL.R`.

### `Case_Study`

#### `Code`
The following scripts can be run in the order given to reproduce the case study results in Sections 4.3 and 4.4. The working directory should be set to the top level directory within this project.

- `case_study_MCMC_run_linked_precision.m`. Run MCMC for proposed method using (synthetic) data for the case study and return samples generated.

- `case_study_MCMC_run_single_graph_estimation.m`. Run MCMC for estimating each graph individually using (synthetic) data for the case study and return samples generated. These results are used in comparing alternative approaches, found in Section 4.4 (Results from alternative approaches).

- `case_study_run_fused_graphical_lasso.R`. Estimate graphs via the fused graphical lasso method, using using (synthetic) data for the case study and return samples generated. These results are used in comparing alternative approaches, found in Section 4.4 (Results from alternative approaches). Code depends on R package `JGL`.

- `case_study_tables.R` Call the scripts found in `Tables` to calculate the values found in Tables 1, 2, and S2.

- `case_study_figures.R` Call the scripts found in `Figures` to generate the files used to create Figures 1, 2, 3, and S2.

#### `Figures`

The following scripts can be run to create the tables found in the paper. The figures can be reproduced using `real results data` found in the `Data` directory.

- `create_histogram.R`. Used to create Figure 1 (Section 4.3), which plots a histogram of the posterior probability of inclusion (PPI) for each group, and a scatterplot of PPIs for two groups. Script requires R package `plotrix`.

- `create_heatmap.R`. Used to create the heatmaps of the posterior probability of inclusion found in Figure 2 (Section 4.3). Script requires R packages `ggplot2` , `reshape2` , `grid` and `plyr`.

- `create_networks_by_lobe.R`. Used to create the igraph figures found in Figure 3 (Section 4.3). Script requires R package `iGraph`.

- `create_full_networks.R`. Used to create the igraph figures found in Figure S2 of the supplement. Script requires R package `iGraph`.

#### `Tables`

The following scripts can be run to create the tables found in the paper.

- `calculate_shared_and_total_edges.R`. Used to calculate the number of edges shared across groups, and number of total edges per group. Results are reported in Table 1, found in Section 4.3.

- `calculate_unique_edges.R`. Used to calculate the number of edges that are unique to each group. Results are reported in Table 1, found in Section 4.3.

- `calculate_small_world_metrics.R`. Used to calcualte the small world metrics found in Section 4.3. Script requires R packages `iGraph` and `brainGraph`.

- `calculate_methods_comparison_tables.R`. Used to compare networks from alternative methods. Results are reported in Table 2, found in Section 4.3.

- `calculate_edges_lost.R`. Used to calculate the number of edges during the progression of Alzheimer's Disease. Results are reported in Table S2, found in the appendix.

#### `Output Files`
This directory contains results that are to be analyzed for creation of the tables and figures associated with the Alzheimer's case study. Note that these are results based on the synthetic data designed to mimic the real data. For convience the results are included, but can be directly generated by running `case_study_MCMC_run_linked_precision.m`, `case_study_MCMC_run_single_graph_estimation.m`, and `case_study_run_fused_graphical_lasso.R`. This directory also includes pdf files generated from `case_study_figures.R`, to create the associated figures.

#### `Input Files`
This directory contains four csv files names appropriatly for the group the data represents. The was simulated to represent the actual data in the case study, and is called by `case_study_MCMC_run_linked_precision.m`, `case_study_MCMC_run_single_graph_estimation.m`, and `case_study_run_fused_graphical_lasso.R` to get results.


#### Acknowledgements

The code provided here either includes or calls code associated with the following publications:

- Danaher P, Wang P, and Witten DM. (2014). The joint graphical lasso for inverse covariance estimation across multiple classes. *Journal of the Royal Statistical Society: Series B (Statistical Methodology)*, 76(2), 373-397.
- Wang H. (2015). Scaling it up: Stochastic search structure learning in graphical models. *Bayesian Analysis*, 10(2), 351-377.
- Shaddox E, Stingo FC, Peterson CB, Jacobson S, Cruickshank-Quinn C, Kechris K, Bowler R, and Vannucci M. (2018). A Bayesian approach for learning gene networks underlying disease severity in COPD. *Statistics in Biosciences*, 10(1): 59-85.




